<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Escanea tus facturas para ser m√°s √°gil el proceso.</title>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc =
         "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    </script>
    
    <!-- Tesseract.js para OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

    <style>
        :root{
            --bg: #f4f7fb;
            --card: #ffffff;
            --muted: #6b7280;
            --accent: #2b6ef6;
            --accent-2: #06b6d4;
            --danger: #ef4444;
            --success: #16a34a;
            --shadow: rgba(15,23,42,0.06);
        }
        html,body{height:100%;}
        body{font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; margin:0; background:var(--bg); color:#0f172a}

        .container{max-width:1100px; margin:24px auto; padding:18px}
        .top-row{display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap}

        .title h1{margin:0; font-size:22px}
        .title .subtitle{margin:4px 0 0 0; color:var(--muted); font-size:13px}

        /* File button */
        .file-btn{display:inline-flex; align-items:center; gap:8px; background:#fff; border-radius:8px; padding:6px 10px; border:1px solid #e6eefc; cursor:pointer}
        .file-btn input[type=file]{position:absolute; left:-9999px}
        .controls-inline{display:flex; gap:10px; align-items:center}

        /* Buttons */
        .btn{background:linear-gradient(180deg,var(--accent),#1d4ed8); color:white; border: none; padding:8px 12px; border-radius:8px; cursor:pointer; box-shadow: 0 8px 30px var(--shadow); transition: transform .12s ease, box-shadow .12s ease; font-weight:600}
        .btn:hover{transform:translateY(-2px)}
        .btn.secondary{background:linear-gradient(180deg,var(--danger),#dc2626)}
        .btn.ghost{background:transparent; color:var(--accent); border:1px solid rgba(37,99,235,0.08); box-shadow:none}
        .btn[disabled]{opacity:0.55; cursor:not-allowed; transform:none}

        /* Controls box */
        .inline-actions{display:flex; gap:8px; align-items:center}

        /* Card summary */
        .card{background:var(--card); border-radius:12px; padding:12px 16px; box-shadow: 0 8px 30px var(--shadow); margin-top:16px}
        #summary{display:flex; gap:12px; align-items:center}
        .summary-item{flex:0 0 200px; background:linear-gradient(180deg,#fff,#fbfdff); padding:12px; border-radius:10px; text-align:center}
        .summary-item.no-bg{background:transparent}
        .summary-item .label{font-size:12px; color:var(--muted)}
        .summary-item .value{font-size:20px; font-weight:800}

        /* Progress - DISE√ëO MEJORADO */
        .progress-container{
            display:none; 
            flex-direction:column;
            gap:12px; 
            margin-top:20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
        }
        
        #progress-info{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:8px;
        }
        
        #progress-status{
            color: white;
            font-size: 15px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            flex: 1;
        }
        
        #progress-text{
            color: white;
            font-size: 22px;
            font-weight: 900;
            text-shadow: 0 2px 6px rgba(0,0,0,0.3);
            min-width: 70px;
            text-align: right;
            letter-spacing: 1px;
        }
        
        #progress-bar-wrap{
            height: 28px;
            background: rgba(255,255,255,0.2);
            border-radius: 14px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        #progress-bar-fill{
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #10b981 0%, #34d399 50%, #6ee7b7 100%);
            transition: width .5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
        }
        
        #progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Table */
        table{width:100%; border-collapse:collapse; background:var(--card)}
        thead th{background:#f8fafc; padding:14px 16px; text-align:left; font-weight:700; color:#0f172a}
        tbody td{padding:12px 16px; border-top:1px solid #f1f5f9}
        tbody tr:hover td{background:#fbfdff}
        .editable{outline:none; min-width:60px}
        .cantidad{width:110px}
        .precio{width:140px; text-align:right}
        .importe{width:140px; text-align:right; font-weight:700}
        .acciones{width:100px; text-align:center}
        .btn-delete{background:var(--danger); color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600; transition:background .2s ease}
        .btn-delete:hover{background:#dc2626}
        .editable:focus{background:#fffbe6}

        /* Footer small */
        .small-note{color:var(--muted); font-size:12px; margin-top:10px}

        /* Responsive */
        @media (max-width:820px){
            .summary-item{flex:1}
            .controls-inline{width:100%; gap:8px}
            .top-row{flex-direction:column; align-items:flex-start}
        }
    </style>
</head>

<body>

<div class="container">
  <div class="top-row">
    <div class="title">
      <h1>üìÑ Escanea tus facturas - Extracci√≥n inteligente de datos</h1>
      <p class="subtitle"></p>
    </div>

    <div class="controls-inline">
      <label class="file-btn">Seleccionar archivos
        <input type="file" id="pdfFile" accept="application/pdf,image/*" multiple>
      </label>
      <span id="fileSelectionInfo" style="margin-left:10px; color:var(--muted); font-size:13px;">No hay archivos seleccionados</span>
      
      <!-- Botones mejorados -->
      <button class="btn" onclick="procesarPDF()" title="PDFs con texto o escaneados">üîç Procesar TODO</button>
      

      <div id="controls" class="inline-actions">
        <button id="limpiarPaginaBtn" class="btn secondary" onclick="limpiarPagina()">Limpiar p√°gina</button>
        <button id="limpiarCacheBtn" class="btn" onclick="limpiarCache()">Limpiar cach√©</button>
        <button id="sendBtn" class="btn" onclick="openSendModal()" disabled>üì§ Enviar</button>
      </div>
    </div>
  </div>

<div id="progress-container" class="progress-container" aria-hidden="true">
    <div id="progress-info">
        <div id="progress-status">Iniciando...</div>
        <div id="progress-text">0%</div>
    </div>
    <div id="progress-bar-wrap">
        <div id="progress-bar-fill"></div>
    </div>
</div>

<div id="summary" class="card">
    <div class="summary-item">
        <span class="label">Partidas</span>
        <span id="partidas" class="value">0</span>
    </div>
    <div class="summary-item">
        <span class="label">Total productos</span>
        <span id="totalProductos" class="value">0</span>
    </div>
    <div class="summary-item">
        <span class="label">Importe total</span>
        <span id="importeTotal" class="value">0.00</span>
    </div>
    <div class="summary-item no-bg">
        <span class="label">IVA 16%</span>
        <span id="ivaTotal" class="value">0.00</span>
    </div>
    <div class="summary-item no-bg">
        <span class="label">Total + IVA</span>
        <span id="importeTotalConIva" class="value">0.00</span>
    </div>
</div>

<div id="sendModal" class="card" style="display:none; margin-top:12px;" aria-hidden="true">
  <div style="display:flex; align-items:center; gap:8px;">
    <label for="sendName" style="font-weight:600; margin-right:6px;">Nombre de la factura</label>
    <input id="sendName" type="text" placeholder="Ej. Orden ABC" style="flex:1; padding:8px; border-radius:6px; border:1px solid #e6eefc" />
    <button class="btn" id="confirmSendBtn" onclick="confirmSend()">Confirmar env√≠o</button>
    <button class="btn ghost" onclick="closeSendModal()">Cancelar</button>
  </div>
  <div id="sendStatus" style="margin-top:8px; font-size:13px; color:var(--muted);"></div>
</div>

<div class="table-card card">
<table>
    <thead>
        <tr>
            <th>Cantidad</th>
            <th>C√≥digo</th>
            <th>Descripci√≥n</th>
            <th>Precio</th>
            <th>Importe</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody id="resultado"></tbody>
</table>
</div>

<script>
// ===== FUNCIONES COMUNES (SIN CAMBIOS) =====
function updateProgress(percent, status = '') {
    const bar = document.getElementById('progress-bar-fill');
    const txt = document.getElementById('progress-text');
    const statusEl = document.getElementById('progress-status');
    if (bar) bar.style.width = percent + '%';
    if (txt) txt.textContent = percent + '%';
    if (statusEl && status) statusEl.textContent = status;
}

function updateFileSelectionInfo() {
    const fileInput = document.getElementById('pdfFile');
    const info = document.getElementById('fileSelectionInfo');
    if (!info) return;
    if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
        info.textContent = 'No hay archivos seleccionados';
    } else if (fileInput.files.length === 1) {
        info.textContent = '1 archivo seleccionado: ' + fileInput.files[0].name;
    } else {
        info.textContent = fileInput.files.length + ' archivos seleccionados';
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const fi = document.getElementById('pdfFile');
    if (fi) fi.addEventListener('change', updateFileSelectionInfo);
    updateFileSelectionInfo();
});

// ===== FUNCI√ìN DE PRE-PROCESAMIENTO DE IMAGEN PARA OCR =====
function preprocessImageForOCR(canvas) {
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    
    // PASO 1: Convertir a escala de grises y eliminar marcas de color
    for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        
        // Detectar marcas de color (naranjas, amarillos, etc.)
        const isColorMark = (r > 200 && g > 150 && b < 150) || // Naranjas
                           (r > 200 && g > 200 && b < 150) || // Amarillos
                           (r > 180 && g < 100 && b < 100);   // Rojos
        
        if (isColorMark) {
            // Convertir marcas de color a blanco para eliminarlas
            data[i] = data[i + 1] = data[i + 2] = 255;
        } else {
            // Escala de grises usando luminosidad ponderada
            const gray = 0.299 * r + 0.587 * g + 0.114 * b;
            data[i] = data[i + 1] = data[i + 2] = gray;
        }
    }
    
    // PASO 2: Aumentar contraste y aplicar umbralizaci√≥n adaptativa
    const threshold = 127; // Umbral para binarizaci√≥n
    for (let i = 0; i < data.length; i += 4) {
        const gray = data[i];
        
        // Aumentar contraste
        let contrast = ((gray - 128) * 1.5) + 128;
        contrast = Math.max(0, Math.min(255, contrast));
        
        // Binarizaci√≥n: blanco o negro
        const binary = contrast > threshold ? 255 : 0;
        data[i] = data[i + 1] = data[i + 2] = binary;
    }
    
    // PASO 3: Reducir ruido (eliminar p√≠xeles aislados)
    const width = canvas.width;
    const height = canvas.height;
    const cleanData = new Uint8ClampedArray(data);
    
    for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
            const idx = (y * width + x) * 4;
            const neighbors = [
                data[((y-1) * width + x) * 4],     // arriba
                data[((y+1) * width + x) * 4],     // abajo
                data[(y * width + (x-1)) * 4],     // izquierda
                data[(y * width + (x+1)) * 4]      // derecha
            ];
            
            const whiteCount = neighbors.filter(n => n > 200).length;
            
            // Si es un p√≠xel negro rodeado de blancos, convertir a blanco
            if (data[idx] < 50 && whiteCount >= 3) {
                cleanData[idx] = cleanData[idx + 1] = cleanData[idx + 2] = 255;
            }
        }
    }
    
    // Aplicar datos limpios
    for (let i = 0; i < data.length; i++) {
        data[i] = cleanData[i];
    }
    
    ctx.putImageData(imageData, 0, 0);
    console.log('‚úì Imagen preprocesada: marcas de color eliminadas, contraste mejorado');
    return canvas;
}

// ===== FUNCI√ìN MEJORADA: procesarPDF (detecta texto vs escaneado) =====
async function procesarPDF() {
    const fileInput = document.getElementById('pdfFile');
    if (!fileInput.files.length) {
        alert("Selecciona al menos un archivo");
        return;
    }

    const pdfFiles = Array.from(fileInput.files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
    const imageFiles = Array.from(fileInput.files).filter(f => f.type.startsWith('image/'));

    if (!pdfFiles.length && !imageFiles.length) {
        alert("Selecciona PDFs o im√°genes");
        return;
    }

    document.getElementById('progress-container').style.display = 'flex';
    updateProgress(0, 'Iniciando...');

    let textoCompleto = "";
    let processedCount = 0;
    const totalFiles = pdfFiles.length + imageFiles.length;

    // PROCESAR PDFs (texto + escaneados MEJORADO)
    for (const file of pdfFiles) {
        updateProgress(Math.round((processedCount / totalFiles) * 100), `Procesando: ${file.name}`);
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let pdfText = "";

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                let pageText = "";
                content.items.forEach(item => { pageText += item.str + " "; });

                // SI LA P√ÅGINA TIENE POCO TEXTO O ES ILEGIBLE = ES IMAGEN ESCANEADA
                const cleanText = pageText.replace(/[\s\n\r]+/g, ' ').trim();
                const hasRelevantText = /[a-zA-Z]{3,}/.test(cleanText) && cleanText.length > 50;
                
                if (!hasRelevantText || cleanText.length < 100) {
                    // Renderizar como imagen y aplicar OCR con mejor calidad
                    const scale = 3.0; // Mayor resoluci√≥n para mejor OCR
                    const viewport = page.getViewport({ scale });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({ canvasContext: context, viewport }).promise;
                    
                    // PRE-PROCESAMIENTO: Mejorar imagen antes del OCR
                    const processedCanvas = preprocessImageForOCR(canvas);
                    const blob = await new Promise(resolve => processedCanvas.toBlob(resolve, 'image/png'));
                    
                    // OCR con m√∫ltiples configuraciones para mejor precisi√≥n
                    const { data: { text } } = await Tesseract.recognize(
                        blob, 
                        'spa+eng', // Espa√±ol e ingl√©s
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    const baseProgress = ((processedCount + (i / pdf.numPages)) / totalFiles) * 100;
                                    updateProgress(Math.round(baseProgress), `OCR P√°gina ${i}/${pdf.numPages} - ${Math.round(m.progress * 100)}%`);
                                    console.log(`OCR P√°gina ${i}/${pdf.numPages}: ${Math.round(m.progress * 100)}%`);
                                }
                            }
                        }
                    );
                    pdfText += text + "\n";
                    console.log(`‚úì P√°gina ${i} procesada con OCR`);
                } else {
                    pdfText += pageText + "\n";
                    console.log(`‚úì P√°gina ${i} procesada (texto nativo)`);
                }
                // Actualizar progreso por p√°gina
                const baseProgress = ((processedCount + (i / pdf.numPages)) / totalFiles) * 100;
                updateProgress(Math.round(baseProgress), `PDF: P√°gina ${i}/${pdf.numPages}`);
            }
            textoCompleto += pdfText + "\n\n";
            console.log(`‚úì PDF "${file.name}" completado`);
        } catch (e) {
            console.error('Error PDF:', file.name, e);
            alert(`Error procesando ${file.name}: ${e.message}`);
        }
        processedCount++;
        updateProgress(Math.round((processedCount / totalFiles) * 100));
    }

    // PROCESAR IM√ÅGENES (si hay) con OCR mejorado
    for (const imageFile of imageFiles) {
        updateProgress(Math.round((processedCount / totalFiles) * 100), `Procesando: ${imageFile.name}`);
        try {
            // Cargar imagen y pre-procesarla
            const imgBitmap = await createImageBitmap(imageFile);
            const canvas = document.createElement('canvas');
            canvas.width = imgBitmap.width;
            canvas.height = imgBitmap.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(imgBitmap, 0, 0);
            
            // PRE-PROCESAMIENTO: Eliminar marcas de color y mejorar contraste
            const processedCanvas = preprocessImageForOCR(canvas);
            const blob = await new Promise(resolve => processedCanvas.toBlob(resolve, 'image/png'));
            
            const { data: { text } } = await Tesseract.recognize(
                blob, 
                'spa+eng', // Espa√±ol e ingl√©s
                {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const baseProgress = (processedCount / totalFiles) * 100;
                            const ocrProgress = (m.progress / totalFiles) * 100;
                            updateProgress(Math.round(baseProgress + ocrProgress), `OCR Imagen: ${Math.round(m.progress * 100)}%`);
                            console.log(`OCR Imagen ${imageFile.name}: ${Math.round(m.progress * 100)}%`);
                        }
                    }
                }
            );
            textoCompleto += text + "\n\n";
            console.log(`‚úì Imagen "${imageFile.name}" procesada`);
        } catch (e) {
            console.error('Error imagen:', imageFile.name, e);
            alert(`Error procesando ${imageFile.name}: ${e.message}`);
        }
        processedCount++;
        updateProgress(Math.round((processedCount / totalFiles) * 100));
    }

    console.log("=== TEXTO EXTRA√çDO COMPLETO ===");
    console.log(textoCompleto);
    console.log("================================");

    updateProgress(95, 'Extrayendo productos...');
    extraerProductos(textoCompleto);
    updateProgress(100, '¬°Completado!');
    document.getElementById('summary').style.display = 'flex';
    setTimeout(() => { 
        document.getElementById('progress-container').style.display = 'none'; 
        const statusEl = document.getElementById('progress-status');
        if (statusEl) statusEl.textContent = '';
    }, 1500);
}

// ===== FUNCI√ìN OCR SOLO IM√ÅGENES (mejorado) =====
async function procesarImagenOCR() {
    const fileInput = document.getElementById('pdfFile');
    const imageFiles = Array.from(fileInput.files).filter(file => 
        file.type.startsWith('image/') || file.name.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)
    );

    if (!imageFiles.length) {
        alert("Selecciona al menos una imagen (JPG, PNG, etc.)");
        return;
    }

    document.getElementById('progress-container').style.display = 'flex';
    updateProgress(0, 'Iniciando OCR...');

    let textoCompleto = "";
    let imagesProcessed = 0;

    for (const imageFile of imageFiles) {
        updateProgress(Math.round((imagesProcessed / imageFiles.length) * 100), `Procesando: ${imageFile.name}`);
        try {
            // Cargar imagen y pre-procesarla
            const imgBitmap = await createImageBitmap(imageFile);
            const canvas = document.createElement('canvas');
            canvas.width = imgBitmap.width;
            canvas.height = imgBitmap.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(imgBitmap, 0, 0);
            
            // PRE-PROCESAMIENTO: Eliminar marcas de color y mejorar contraste
            const processedCanvas = preprocessImageForOCR(canvas);
            const blob = await new Promise(resolve => processedCanvas.toBlob(resolve, 'image/png'));
            
            const { data: { text } } = await Tesseract.recognize(
                blob, 
                'spa+eng',
                {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const baseProgress = (imagesProcessed / imageFiles.length) * 100;
                            const ocrProgress = (m.progress / imageFiles.length) * 100;
                            updateProgress(Math.round(baseProgress + ocrProgress), `OCR: ${Math.round(m.progress * 100)}%`);
                            console.log(`OCR: ${Math.round(m.progress * 100)}%`);
                        }
                    }
                }
            );
            textoCompleto += text + "\n\n";
            imagesProcessed++;
            console.log(`‚úì Imagen "${imageFile.name}" procesada`);
        } catch (error) {
            console.error('Error procesando imagen:', imageFile.name, error);
            alert(`Error procesando ${imageFile.name}: ${error.message}`);
        }
    }

    console.log("=== TEXTO EXTRA√çDO DE IM√ÅGENES ===");
    console.log(textoCompleto);
    console.log("====================================");

    updateProgress(95, 'Extrayendo productos...');
    extraerProductos(textoCompleto);
    updateProgress(100, '¬°Completado!');
    document.getElementById('summary').style.display = 'flex';
    setTimeout(() => { 
        document.getElementById('progress-container').style.display = 'none';
        const statusEl = document.getElementById('progress-status');
        if (statusEl) statusEl.textContent = '';
    }, 1500);
}

// ===== TUS FUNCIONES ORIGINALES (100% INTACTAS) =====
function parsePrice(str) {
    if (!str) return 0;
    let s = String(str).trim().replace(/\s+/g, '');
    if (s.indexOf(',') > -1) {
        if (s.indexOf('.') > -1) {
            if (s.lastIndexOf('.') < s.lastIndexOf(',')) {
                s = s.replace(/\./g, '').replace(/,/g, '.');
            } else {
                s = s.replace(/,/g, '');
            }
        } else {
            s = s.replace(/,/g, '.');
        }
    }
    s = s.replace(/[^0-9.\-]/g, '');
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
}

function formatCurrency(n) {
    return new Intl.NumberFormat('es-MX', {minimumFractionDigits:2, maximumFractionDigits:2}).format(n);
}

function updateRowImporte(tr) {
    if (!tr) return;
    const tds = tr.querySelectorAll('td');
    const qty = parseInt(tds[0].textContent.trim().replace(/[^0-9\-]+/g, ''), 10) || 0;
    const precioStr = tds[3] ? tds[3].textContent.trim() : '';
    const precioNum = parsePrice(precioStr);
    const importe = qty * precioNum;
    const tdImp = tr.querySelector('.importe');
    if (tdImp) tdImp.textContent = formatCurrency(importe);
}

function updateResumen() {
    const tbody = document.getElementById('resultado');
    const partidas = tbody.children.length;
    let totalProductos = 0;
    let importeTotal = 0;

    Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
        const tds = tr.querySelectorAll('td');
        const cantidadTd = tds[0];
        const precioTd = tds[3];
        const v = cantidadTd ? cantidadTd.textContent.trim().replace(/[^0-9\-]+/g, '') : '0';
        const cantidad = parseInt(v, 10);
        const qty = isNaN(cantidad) ? 0 : cantidad;
        totalProductos += qty;

        const precioStr = precioTd ? precioTd.textContent.trim() : '';
        const precioNum = parsePrice(precioStr);
        importeTotal += qty * precioNum;
    });

    const ivaAmount = importeTotal * 0.16;
    const totalConIva = importeTotal + ivaAmount;

    document.getElementById('partidas').textContent = partidas;
    document.getElementById('totalProductos').textContent = totalProductos;
    document.getElementById('importeTotal').textContent = formatCurrency(importeTotal);
    document.getElementById('ivaTotal').textContent = formatCurrency(ivaAmount);
    document.getElementById('importeTotalConIva').textContent = formatCurrency(totalConIva);
    document.getElementById('summary').style.display = 'flex';
    toggleSendButton();
}  

function extraerProductos(texto) {
    const tbody = document.getElementById("resultado");
    tbody.innerHTML = "";

    // Array de patrones para diferentes formatos de facturas
    const patrones = [
        // Patr√≥n 1: [cantidad] pz [codigo] [descripcion] $ [precio]
        /(\d+)\s+pz\s+([A-Z0-9\-]+)\s+(.*?)(?:\s+[A-Z0-9\/\-]{1,6})?\s+\$\s*([0-9.,]+)/gi,
        
        // Patr√≥n 2: [cantidad] [unidad] [codigo] [descripcion] [precio]
        /(\d+)\s+(?:pz|pza|pieza|und|unidad|kg|lt|m|cm)\s+([A-Z0-9\-]{3,})\s+(.*?)\s+\$?\s*([0-9.,]+)(?:\s|$)/gi,
        
        // Patr√≥n 3: [codigo] [descripcion] [cantidad] [precio] [importe]
        /([A-Z0-9\-]{3,})\s+(.*?)\s+(\d+)\s+\$?\s*([0-9.,]+)\s+\$?\s*[0-9.,]+/gi,
        
        // Patr√≥n 4: Formato tabla simple [cant] [desc] [precio]
        /(\d+)\s+(.*?)\s+\$?\s*([0-9.,]+)$/gmi,
        
        // Patr√≥n 5: Con c√≥digo entre cantidad y descripci√≥n
        /(\d+)\s+([A-Z0-9\-]{3,})\s+(.*?)\s+\$?\s*([0-9.,]+)/gi,
        
        // Patr√≥n 6: Cantidad al final [codigo] [descripcion] [precio] [cantidad]
        /([A-Z0-9\-]{3,})\s+(.*?)\s+\$?\s*([0-9.,]+)\s+(\d+)/gi,
        
        // Patr√≥n 7: Sin c√≥digo, solo cantidad descripci√≥n y precio
        /(\d+)\s+(.*?(?:material|producto|articulo|servicio|instalacion)[^$]*?)\s+\$?\s*([0-9.,]+)/gi
    ];

    const productosEncontrados = new Set();
    let totalEncontrados = 0;
    let totalFiltrados = 0;

    patrones.forEach((regex, idx) => {
        regex.lastIndex = 0; // Reset regex
        let match;
        
        while ((match = regex.exec(texto)) !== null) {
            totalEncontrados++;
            let cantidad, codigo, descripcion, precio;

            // Adaptar seg√∫n el patr√≥n
            if (idx === 0 || idx === 1 || idx === 4) {
                // [cantidad] [codigo] [descripcion] [precio]
                cantidad = match[1];
                codigo = match[2] || 'N/A';
                descripcion = match[3].trim();
                precio = match[4] || '0';
            } else if (idx === 2) {
                // [codigo] [descripcion] [cantidad] [precio]
                cantidad = match[3];
                codigo = match[1];
                descripcion = match[2].trim();
                precio = match[4];
            } else if (idx === 3 || idx === 6) {
                // [cantidad] [descripcion] [precio] (sin c√≥digo)
                cantidad = match[1];
                codigo = 'N/A';
                descripcion = match[2].trim();
                precio = match[3] || '0';
            } else if (idx === 5) {
                // [codigo] [descripcion] [precio] [cantidad]
                cantidad = match[4];
                codigo = match[1];
                descripcion = match[2].trim();
                precio = match[3];
            }

            // ===== VALIDACIONES MEJORADAS =====
            if (!cantidad || !descripcion || !precio) {
                totalFiltrados++;
                continue;
            }
            
            // 1. Validar CANTIDAD
            const cantNum = parseInt(cantidad, 10);
            if (isNaN(cantNum) || cantNum <= 0 || cantNum > 100000) {
                totalFiltrados++;
                continue;
            }
            
            // 2. Validar C√ìDIGO (debe tener sentido y ser suficientemente largo)
            if (codigo && codigo !== 'N/A') {
                // FILTRO: Si el c√≥digo tiene menos de 5 caracteres, rechazar toda la l√≠nea
                if (codigo.length < 5) {
                    totalFiltrados++;
                    console.log(`‚ö†Ô∏è Filtrado: C√≥digo muy corto (${codigo.length} caracteres): "${codigo}"`);
                    continue;
                }
                
                // FILTRO: Si el c√≥digo contiene palabras completas en espa√±ol/ingl√©s, rechazar
                const palabrasProhibidas = /\b(DIRECCION|TRACCION|TOTAL|DATOS|PARTIDAS|CLIENTE|FECHA|METODO|PAGO|FORMA|EXPEDICION|EXPORTACION|MATERIAL|PRODUCTO|SERVICIO|ARTICULO|DESCRIPCION|CANTIDAD|PRECIO|IMPORTE|NOMBRE|FACTURA|ORDEN|PEDIDO|COTIZACION)\b/i;
                if (palabrasProhibidas.test(codigo)) {
                    totalFiltrados++;
                    console.log(`‚ö†Ô∏è Filtrado: C√≥digo contiene palabras: "${codigo}"`);
                    continue;
                }
                
                // FILTRO: Si el c√≥digo es solo letras sin n√∫meros (palabras), rechazar
                if (/^[A-Z]+$/i.test(codigo) && codigo.length > 3) {
                    totalFiltrados++;
                    console.log(`‚ö†Ô∏è Filtrado: C√≥digo es solo letras (palabra): "${codigo}"`);
                    continue;
                }
                
                // Eliminar c√≥digos con caracteres extra√±os
                if (/[^A-Z0-9\-\/]/.test(codigo)) {
                    totalFiltrados++;
                    console.log(`‚ö†Ô∏è Filtrado: C√≥digo con caracteres inv√°lidos: "${codigo}"`);
                    continue;
                }
            } else {
                // Si no hay c√≥digo v√°lido, tambi√©n filtrar
                totalFiltrados++;
                console.log(`‚ö†Ô∏è Filtrado: Sin c√≥digo v√°lido`);
                continue;
            }
            
            // 3. Limpiar y validar DESCRIPCI√ìN
            descripcion = descripcion
                .replace(/\s+/g, ' ')
                .replace(/[|\(\)\[\]]/g, '')
                .replace(/H87|H\d+/g, '') // Quitar c√≥digos H87 que aparecen en las descripciones
                // NO eliminamos R16, R17, R18 etc porque son medidas de rin importantes
                .replace(/\$[\d,\.]+/g, '') // Quitar precios dentro de descripci√≥n
                .replace(/\b\d+\.\d{4,}%?\b/g, '') // Quitar porcentajes largos
                .trim();
            
            // Descripci√≥n muy corta = dato malo
            if (descripcion.length < 5) {
                totalFiltrados++;
                continue;
            }
            
            // Descripci√≥n muy larga o con muchos n√∫meros = dato malo
            if (descripcion.length > 150) {
                descripcion = descripcion.substring(0, 150);
            }
            
            // Si la descripci√≥n es 80% n√∫meros, probablemente est√° mal
            const numCount = (descripcion.match(/\d/g) || []).length;
            if (numCount / descripcion.length > 0.5) {
                totalFiltrados++;
                continue;
            }
            
            // Si tiene demasiados espacios seguidos o caracteres raros
            if (/\s{5,}/.test(descripcion) || /[^\w\s√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë.,\-\/]/g.test(descripcion)) {
                totalFiltrados++;
                continue;
            }
            
            // FILTRO: Si la descripci√≥n contiene palabras prohibidas (no son productos)
            const palabrasProhibidasDesc = /\b(TASA|DESCUENTO|TOTAL|SUBTOTAL|IVA|IMPUESTO|CARGO|COMISION|PAGO|SALDO|CREDITO|DEBITO|TRANSFERENCIA|ENVIO|FLETE|TRANSPORTE|CUOTA|INTERES|NOTA|OBSERVACION|COMENTARIO|PARTIDAS|FOLIO|FACTURA|COTIZACION|PEDIDO|ORDEN|CLIENTE|PROVEEDOR|DATOS|EXPEDICION|METODO|FORMA)\b/i;
            if (palabrasProhibidasDesc.test(descripcion)) {
                totalFiltrados++;
                console.log(`‚ö†Ô∏è Filtrado: Descripci√≥n contiene palabra prohibida: "${descripcion.substring(0, 50)}..."`);
                continue;
            }
            
            // 4. Validar PRECIO
            const precioLimpio = precio.replace(/[^0-9.,]/g, '').replace(/,/g, '').trim();
            const precioNum = parsePrice(precioLimpio);
            
            // Precio inv√°lido o demasiado bajo/alto
            if (isNaN(precioNum) || precioNum <= 0 || precioNum > 1000000) {
                totalFiltrados++;
                continue;
            }
            
            // ===== SIN FILTRO DE DUPLICADOS =====
            // Se muestran TODOS los productos, incluso si parecen similares
            // Esto permite ver variaciones sutiles en c√≥digos o descripciones

            // Ya validamos y limpiamos el precio arriba
            const fila = document.createElement("tr");
            fila.innerHTML = `
                <td contenteditable="true" class="editable cantidad">${cantidad}</td>
                <td contenteditable="true" class="editable">${codigo}</td>
                <td contenteditable="true" class="editable">${descripcion}</td>
                <td contenteditable="true" class="editable precio">${precioLimpio}</td>
                <td class="importe">${formatCurrency((parseInt(cantidad,10)||0) * parsePrice(precioLimpio))}</td>
                <td class="acciones"><button class="btn-delete" onclick="eliminarFila(this)">Eliminar</button></td>
            `;
            tbody.appendChild(fila);

            const tdCantidad = fila.querySelector('.cantidad');
            if (tdCantidad) {
                tdCantidad.addEventListener('input', (e) => {
                    e.target.textContent = e.target.textContent.replace(/[^0-9\-]/g, '');
                    updateRowImporte(fila);
                    updateResumen();
                });
                tdCantidad.addEventListener('blur', (e) => {
                    if (!e.target.textContent.trim()) e.target.textContent = '0';
                    updateRowImporte(fila);
                    updateResumen();
                });
            }

            const tdPrecio = fila.querySelector('.precio');
            if (tdPrecio) {
                tdPrecio.addEventListener('input', (e) => {
                    e.target.textContent = e.target.textContent.replace(/[^0-9.,-]/g, '');
                    updateRowImporte(fila);
                    updateResumen();
                });
                tdPrecio.addEventListener('blur', (e) => {
                    if (!e.target.textContent.trim()) e.target.textContent = '0';
                    updateRowImporte(fila);
                    updateResumen();
                });
            }
        }
    });

    updateResumen();

    // Mostrar estad√≠sticas de filtrado
    console.log(`üìä Estad√≠sticas de extracci√≥n:`);
    console.log(`   Total encontrados: ${totalEncontrados}`);
    console.log(`   ‚úÖ V√°lidos: ${tbody.children.length}`);
    console.log(`   ‚ùå Filtrados: ${totalFiltrados}`);

    if (!tbody.children.length) {
        console.warn("‚ö†Ô∏è No se encontraron productos con los patrones actuales");
        console.log("üìù Texto procesado:", texto.substring(0, 500) + "...");
        alert("‚ö†Ô∏è No se encontraron productos v√°lidos.\n\n" +
              "Los datos fueron filtrados por:\n" +
              "‚ùå C√≥digos muy cortos (< 5 caracteres)\n" +
              "‚ùå C√≥digos que contienen palabras (DIRECCION, TOTAL, etc.)\n" +
              "‚ùå C√≥digos solo con letras sin n√∫meros\n" +
              "‚ùå Descripciones con palabras prohibidas (TASA, DESCUENTO, etc.)\n" +
              "‚ùå C√≥digos sin valor o 'N/A'\n" +
              "‚ùå Descripciones muy cortas (< 5 caracteres)\n" +
              "‚ùå Descripciones con muchos n√∫meros\n" +
              "‚ùå Precios fuera de rango (0-1,000,000)\n" +
              "‚ùå Datos incompletos o malformados\n\n" +
              "‚úÖ NO se filtran duplicados - se muestran TODOS los datos\n" +
              "üí° Revisa la consola (F12) para ver el texto extra√≠do");
    } else {
        console.log(`‚úÖ ${tbody.children.length} productos v√°lidos encontrados`);
        if (totalFiltrados > 0) {
            console.log(`üîç ${totalFiltrados} l√≠neas fueron filtradas por no cumplir los criterios de calidad`);
        }
    }
}

function eliminarFila(btn) {
    const fila = btn.closest('tr');
    if (fila) {
        fila.remove();
        updateResumen();
    }
}

function limpiarPagina() {
    try { document.getElementById('pdfFile').value = ''; } catch(e) {}
    try { updateFileSelectionInfo(); } catch(e) {}
    document.getElementById('resultado').innerHTML = '';
    updateProgress(0);
    document.getElementById('partidas').textContent = '0';
    document.getElementById('totalProductos').textContent = '0';
    const impElem = document.getElementById('importeTotal');
    if (impElem) impElem.textContent = '0.00';
    document.getElementById('progress-container').style.display = 'none';

    const sendBtn = document.getElementById('sendBtn');
    if (sendBtn) sendBtn.disabled = true;
    const sendModal = document.getElementById('sendModal');
    if (sendModal) {
        sendModal.style.display = 'none';
        sendModal.setAttribute('aria-hidden', 'true');
    }
    const sendName = document.getElementById('sendName');
    if (sendName) sendName.value = '';
    const sendStatus = document.getElementById('sendStatus');
    if (sendStatus) sendStatus.textContent = '';
    const confirmSendBtn = document.getElementById('confirmSendBtn');
    if (confirmSendBtn) confirmSendBtn.disabled = false;

    window.scrollTo({ top: 0, behavior: 'smooth' });
} 

function limpiarCache() {
    try {
        localStorage.clear();
        sessionStorage.clear();
    } catch (e) {
        console.warn('No se pudo limpiar storage:', e);
    }
    document.cookie.split(";").forEach(function(c) {
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
    });

    if (window.caches && typeof window.caches.keys === 'function') {
        try {
            window.caches.keys().then(keys => Promise.all(keys.map(k => window.caches.delete(k))));
        } catch (e) {
            console.warn('No se pudo limpiar Cache API:', e);
        }
    }

    try { limpiarPagina(); } catch (e) { console.warn('Error al reiniciar la p√°gina:', e); }
    alert('Datos residuales limpiados y p√°gina reiniciada.');
}

const SHEETDB_ENDPOINT = 'https://sheetdb.io/api/v1/mrrlieg6zoleg?sheet=FACTURAS';

function openSendModal() {
    const fileInput = document.getElementById('pdfFile');
    let fileName = '';
    if (fileInput && fileInput.files && fileInput.files.length) {
        if (fileInput.files.length === 1) fileName = fileInput.files[0].name.replace(/\.[^/.]+$/, '');
        else fileName = fileInput.files.length + ' archivos seleccionados';
    }
    document.getElementById('sendModal').style.display = 'block';
    document.getElementById('sendModal').setAttribute('aria-hidden', 'false');
    document.getElementById('sendName').value = fileName || '';
    document.getElementById('sendName').focus();
}

function closeSendModal() {
    document.getElementById('sendModal').style.display = 'none';
    document.getElementById('sendModal').setAttribute('aria-hidden', 'true');
    document.getElementById('sendStatus').textContent = '';
}

async function confirmSend() {
    const name = document.getElementById('sendName').value.trim();
    if (!name) { alert('Introduce un nombre para el traspaso'); document.getElementById('sendName').focus(); return; }
    const rows = Array.from(document.querySelectorAll('#resultado tr')).map(tr => {
        const tds = tr.querySelectorAll('td');
        const qty = parseInt(tds[0].textContent.trim().replace(/[^0-9\-]+/g, ''), 10) || 0;
        const precioStr = tds[3] ? tds[3].textContent.trim() : '';
        const precioNum = parsePrice(precioStr);
        const importe = (qty * precioNum);
        return {
            'Nombre': name,
            'Folio': '',
            'Fecha de Emisi√≥n': new Date().toISOString(),
            'Usuario': '',
            'Cantidad': tds[0].textContent.trim(),
            'C√≥digo': tds[1].textContent.trim(),
            'Descripci√≥n': tds[2].textContent.trim(),
            'valor': precioStr,
            'importe': importe.toFixed(2)
        };
    });
    if (!rows.length) { alert('No hay datos para enviar'); return; }

    document.getElementById('confirmSendBtn').disabled = true;
    document.getElementById('sendStatus').textContent = 'Enviando...';

    try {
        const res = await fetch(SHEETDB_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: rows })
        });

        if (!res.ok) {
            const text = await res.text();
            throw new Error(text || res.statusText);
        }

        const json = await res.json();
        document.getElementById('sendStatus').textContent = 'Enviado correctamente.';
        alert('Enviado correctamente. Filas a√±adidas: ' + (json.length || 'OK'));
        closeSendModal();
        limpiarPagina();
    } catch (err) {
        document.getElementById('sendStatus').textContent = 'Error: ' + err.message;
        const msg = err.message && err.message.includes('Failed to fetch')
            ? 'Error de red o CORS. Verifica la URL de SheetDB.'
            : ('Error al enviar: ' + err.message);
        alert(msg);
    } finally {
        document.getElementById('confirmSendBtn').disabled = false;
    }
}

function toggleSendButton() {
    const partidas = parseInt(document.getElementById('partidas').textContent, 10) || 0;
    const send = document.getElementById('sendBtn');
    if (send) send.disabled = partidas === 0;
}

</script>

</body>
</html>
